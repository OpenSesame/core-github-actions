name: Semgrep Scan

defaults:
  run:
    shell: bash

on:
  workflow_call:
    inputs:
      commit_identifier:
        description: 'Commit SHA or ref to scan (default: current ref)'
        type: string
        required: true
      cancel_in_progress:
        description: 'Cancel in-progress run for the same ref'
        type: boolean
        default: true
      semgrep_config:
        description: Semgrep rulesets to use. Accepts a YAML array, newline or space-separated list. Default is "p/default"
        type: string
        default: p/default
      semgrep_targets:
        description: les/directories to scan. Accepts a YAML array, newline or space-separated list. Default is current directory (`.`)
        type: string
        default: .
      extra_args:
        description: 'Additional arguments to pass to Semgrep (e.g., --exclude, --timeout). Optional.'
        type: string
        default: ''
      semgrep_version:
        description: 'Semgrep version to install. Default: latest.'
        type: string
        default: ''
      fail_severity:
        description: 'error | warning | info'
        type: string
        default: 'error'
      semgrep_scan_mode:
        description: What should Semgrep scan? "full | diff | baseline"
        type: string
        default: 'full'
      baseline_ref:
        description: 'Ref for diff/baseline (e.g., origin/main)'
        type: string
        default: 'origin/main'
      reviewdog_filter_mode:
        description: What should reviewdog display (does not change what Semgrep scans)? "added | diff_context | nofilter"
        type: string
        default: 'nofilter'
      reviewdog_reporter:
        description: 'review output: github-pr-review | github-pr-check (only applies if PR context exists, on push github-check is used)'
        type: string
        default: 'github-pr-review'
    outputs:
      total_findings:
        description: 'Total number of findings'
        value: ${{ jobs.semgrep.outputs.total_findings }}
      error_count:
        description: 'Number of ERROR findings'
        value: ${{ jobs.semgrep.outputs.error_count }}
      warning_count:
        description: 'Number of WARNING findings'
        value: ${{ jobs.semgrep.outputs.warning_count }}
      info_count:
        description: 'Number of INFO findings'
        value: ${{ jobs.semgrep.outputs.info_count }}

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write # needed if reporter is github-pr-check or github-check

concurrency:
  group: semgrep-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ inputs.cancel_in_progress }}

jobs:
  semgrep:
    name: Run Semgrep
    runs-on: ubuntu-latest

    outputs:
      total_findings: ${{ steps.semgrep.outputs.totalFindings }}
      error_count: ${{ steps.semgrep.outputs.numErrors }}
      warning_count: ${{ steps.semgrep.outputs.numWarnings }}
      info_count: ${{ steps.semgrep.outputs.numInfo }}
      scan_status: ${{ steps.semgrep.outputs.scanStatus }}
      scan_md_summary: ${{ steps.semgrep.outputs.scanFindings }}
      config_md_summary: ${{ steps.semgrep.outputs.configSummary }}
      normalized_baseline: ${{ steps.semgrep.outputs.normalizedBaseline }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit_identifier }}
          # Full history only when diff/baseline is requested
          fetch-depth: ${{ inputs.semgrep_scan_mode == 'full' && '1' || '0' }}

      - name: Check for open PR (by commit)
        id: pr_check
        uses: OpenSesame/core-github-actions/.github/actions/pr-open-check@actions/pr-open-check/2.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-identifier: ${{ inputs.commit_identifier }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install dependencies
        run: npm ci --omit=dev

      - name: Install Semgrep
        env:
          SEMGREP_VERSION: ${{ inputs.semgrep_version }}
        run: |
          if [ -n "$SEMGREP_VERSION" ]; then
            python3 -m pip install semgrep==$SEMGREP_VERSION
          else
            python3 -m pip install semgrep
          fi

      - name: Run Semgrep
        id: semgrep
        env:
          INPUT_BASELINE: ${{ inputs.baseline_ref }}
          HAS_PR: ${{ steps.pr_check.outputs.pr_exists }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCAN_MODE: ${{ inputs.semgrep_scan_mode }}
          SEMGREP_CONFIG: ${{ inputs.semgrep_config }}
          SEMGREP_TARGETS: ${{ inputs.semgrep_targets }}
          FAIL_LEVEL: ${{ inputs.fail_severity }}
          EXTRA_ARGS: ${{ inputs.extra_args }}
        run: node scripts/gha-lib/run-semgrep.js

      - name: Upload Artifact
        if: ${{ steps.semgrep.outputs.totalFindings > 0 }}
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-${{ github.run_id }}.json
          path: semgrep_results.json
          if-no-files-found: error
          retention-days: 7

      - name: Set up Reviewdog
        if: ${{ steps.semgrep.outputs.totalFindings > 0 }}
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: v0.20.3

      - name: Normalize Reviewdog settings (push vs PR)
        id: normalized_settings
        if: ${{ steps.semgrep.outputs.totalFindings > 0 }}
        env:
          EVENT_NAME: ${{ github.event_name }}
          REPORTER: ${{ inputs.reviewdog_reporter }}
          FILTER_MODE: ${{ inputs.reviewdog_filter_mode }}
          HAS_PR: ${{ steps.pr_check.outputs.pr_exists }}
        run: |
          set -Eeuo pipefail
          echo "Inputs: event=$EVENT_NAME, has_pr=$HAS_PR"
          echo "- reporter: $REPORTER"
          echo "- filter mode: $FILTER_MODE"

          # Normalize settings so later steps do not need to branch on PR context
          if [[ "$EVENT_NAME" != "pull_request" && "$HAS_PR" != "true" ]]; then
            REPORTER="github-check"
            FILTER_MODE="nofilter"
            echo -e "\nNo PR context; using github-check reporter with nofilter"
          fi

          echo "reporter=$REPORTER" >> "$GITHUB_OUTPUT"
          echo "filterMode=$FILTER_MODE" >> "$GITHUB_OUTPUT"

      - name: Reviewdog report
        if: ${{ steps.semgrep.outputs.totalFindings > 0 }}
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEWDOG_REPORTER: ${{ steps.normalized_settings.outputs.reporter }}
          REVIEWDOG_FILTER_MODE: ${{ steps.normalized_settings.outputs.filterMode }}
          REVIEWDOG_FAIL_LEVEL: ${{ inputs.fail_severity }}
        run: |
          cat reviewdog_input.txt | reviewdog \
            -efm="%t:%f:%l %m" \
            -name="semgrep" \
            -reporter="$REVIEWDOG_REPORTER" \
            -filter-mode="$REVIEWDOG_FILTER_MODE" \
            -fail-level="$REVIEWDOG_FAIL_LEVEL"

      - name: Write job summary
        env:
          HAS_PR: ${{ steps.pr_check.outputs.pr_exists }}
          PR_NUMBER: ${{ steps.pr_check.outputs.pr_number }}
          PR_URL: ${{ steps.pr_check.outputs.pr_url }}
          SCAN_SUMMARY: ${{ steps.semgrep.outputs.scanSummary }}
          CONFIG_SUMMARY: ${{ steps.semgrep.outputs.configSummary }}
          FILTER_MODE: ${{ steps.normalized_settings.outputs.filterMode }}
          REVIEWDOG_REPORTER: ${{ steps.normalized_settings.outputs.reporter }}
        run: |
          {
            echo "## üîé Semgrep Summary"
            echo "triggered by: \`${{ github.event_name }}\` on \`${{ github.ref }}\`"

            if [ "${{ github.event_name }}" = "push" ]; then
              if [ "${HAS_PR}" = "true" ]; then
                echo "- **PR context**: Detected open PR [#${PR_NUMBER}](${PR_URL}); PR-style review settings applied."
              else
                echo "- **PR context**: None for this push; PR-only input settings were overridden."
              fi
            fi
          } >> $GITHUB_STEP_SUMMARY

          echo -e "${SCAN_SUMMARY}" >> $GITHUB_STEP_SUMMARY
          echo -e "${CONFIG_SUMMARY}" >> $GITHUB_STEP_SUMMARY

          echo "- **Review filter**: \`${FILTER_MODE}\`"
          echo "- **Reviewdog reporter**: \`${REVIEWDOG_REPORTER}\`"

      - name: Generate PR comment body
        if: ${{ github.event_name == 'pull_request' || steps.pr_check.outputs.pr_exists == 'true' }}
        id: generate_body
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr_check.outputs.pr_number }}
          SCAN_STATUS: ${{ steps.semgrep.outputs.scanStatus }}
          TOTAL_FINDINGS: ${{ steps.semgrep.outputs.totalFindings }}
          NUM_ERRORS: ${{ steps.semgrep.outputs.numErrors }}
          NUM_WARNINGS: ${{ steps.semgrep.outputs.numWarnings }}
          NUM_INFO: ${{ steps.semgrep.outputs.numInfo }}
          CONFIG_SUMMARY: ${{ steps.semgrep.outputs.configSummary }}
        with:
          result-encoding: string
          script: |
            const scanStatus = process.env.SCAN_STATUS;
            const total   = Number(process.env.TOTAL_FINDINGS || '0');
            const errors  = Number(process.env.NUM_ERRORS || '0');
            const warns   = Number(process.env.NUM_WARNINGS || '0');
            const info    = Number(process.env.NUM_INFO || '0');

            const emoji = scanStatus === 'success' ? "‚úÖ" : "‚ùå";
            const statusText =  scanStatus === 'success' ? "passed" : "failed";

            const heading = `## ${emoji} Semgrep Security Scan ${statusText.charAt(0).toUpperCase() + statusText.slice(1)}`

            const parts = [];
            if (errors > 0) parts.push(`${errors} error${errors === 1 ? "" : "s"}`);
            if (warns  > 0) parts.push(`${warns} warning${warns === 1 ? "" : "s"}`);
            if (info   > 0) parts.push(`${info} info`);

            const findings = total > 0 ? `\n\n${parts.join(", ")}` : "\n\nüéâ No security issues found!";

            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const body = `${heading}
            ${findings}

            [View run](${runUrl})
            <sub>ü§ñ Powered by Semgrep + reviewdog</sub>`;

            core.setOutput('body', body);

      - name: Upsert PR comment
        if: ${{ github.event_name == 'pull_request' || steps.pr_check.outputs.pr_exists == 'true' }}
        uses: OpenSesame/core-github-actions/.github/actions/upsert-pr-comment@actions/upsert-pr-comment/1.0.0
        with:
          pr-number: ${{ steps.pr_check.outputs.pr_number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: semgrep-summary
          body-content: ${{ steps.generate_body.outputs.body }}

      - name: Fail on findings at/above threshold
        if: ${{ steps.semgrep.outputs.scanStatus == 'failure' }}
        env:
          FAIL_SEVERITY: ${{ inputs.fail_severity }}
        run: |
          echo "‚ùå Semgrep exceeded fail_severity='${FAIL_SEVERITY}'"
          exit 1
          # Note: this will fail the job, but we still got findings posted via reviewdog and summary comment.
