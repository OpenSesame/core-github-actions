name: Validate PR Version Labels

on:
  pull_request:
    branches: [main]
    types:
      - opened
      - synchronize
      - edited
      - labeled # important to catch version label additions
      - unlabeled
      - reopened

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-version-labels:
    name: Validate PR Version Labels
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get all labels from PR
        id: get_labels
        run: |
          echo "## PR Labels" >> "$GITHUB_STEP_SUMMARY"

          ## Newline separated list of all labels on the PR
          all_labels=$(jq -r '.pull_request.labels[].name' < "$GITHUB_EVENT_PATH" 2>/dev/null || true)

          if [ -z "$all_labels" ]; then
            echo "- (none)" >> "$GITHUB_STEP_SUMMARY"
            echo "::error title=No Labels::No Labels were found on this PR. A version label is required."
            exit 1
          else
            while IFS= read -r lbl; do
            [ -z "$lbl" ] && continue
            echo "- \`$lbl\`" >> "$GITHUB_STEP_SUMMARY"
            done <<< "$all_labels"
          fi

          echo "$all_labels" > all_labels.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Label Validation
        id: validate
        run: node scripts/internal-ci/validate-version-labels/index.js all_labels.txt

      - name: Validation Job Summary
        if: ${{ always() }}
        env:
          NO_LABELS: ${{ steps.get_labels.outcome == 'failure' }}
          IS_VALID: ${{ steps.validate.outputs.isValid }}
          VALIDATION_MESSAGE: ${{ steps.validate.outputs.validationMessage }}
          INVALID_VERSION_LABELS: ${{ steps.validate.outputs.invalidVersionLabels }}
          HAS_UNTRACKED_VERSION: ${{ steps.validate.outputs.hasUntrackedVersion }}
          COMPONENT_VERSION_LABELS: ${{ steps.validate.outputs.componentVersionLabels }}
          INVALID_COMPONENTS: ${{ steps.validate.outputs.invalidComponents }}
          MISSING_CHANGELOGS: ${{ steps.validate.outputs.missingChangelogs }}
        run: |
          echo "## Validation Outcome" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ env.NO_LABELS }}" === "true" ]; then
            echo "‚ùå No labels found on the PR. Add at least one version label." >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ "${{ env.IS_VALID }}" === "false" ]; then
            echo "‚ùå Version label validation failed." >> "$GITHUB_STEP_SUMMARY"
            if [ -n "${{ env.VALIDATION_MESSAGE }}" ]; then
              echo "${{ env.VALIDATION_MESSAGE }}" >> "$GITHUB_STEP_SUMMARY"
              echo "" >> "$GITHUB_STEP_SUMMARY"
            fi
            if [ -n "${{ env.INVALID_VERSION_LABELS }}" ]; then
              echo "Invalid version labels: ${{ env.INVALID_VERSION_LABELS }}" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo -e "‚úÖ Version label validation passed\n" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "**Untracked Version**: ${{ env.HAS_UNTRACKED_VERSION }}" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${{ env.COMPONENT_VERSION_LABELS }}" ]; then
            echo "**Component Versions**: ${{ env.COMPONENT_VERSION_LABELS }}" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Tags Job Summary
        env:
          HAS_UNTRACKED_VERSION: ${{ steps.validate.outputs.hasUntrackedVersion }}
          VALID_COMPONENTS: ${{ steps.validate.outputs.validComponents }}
        run: |
          echo "## Tags" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ env.HAS_UNTRACKED_VERSION }}" = "true" ]; then
            echo "- No Tags will be created on main" >> "$GITHUB_STEP_SUMMARY"
          else
            echo -e "The following tags will be created on main after merge\n" >> "$GITHUB_STEP_SUMMARY"
            echo "${{ env.VALID_COMPONENTS }}" | tr ',' '\n' | while read -r component_version; do
              echo "üè∑Ô∏è  \`$component_version\`" >> "$GITHUB_STEP_SUMMARY"
            done
          fi

      - name: Tags PR Summary
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HAS_UNTRACKED_VERSION: ${{ steps.validate.outputs.hasUntrackedVersion }}
          VALID_COMPONENTS: ${{ steps.validate.outputs.validComponents }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            let summary = '';

            if (process.env.HAS_UNTRACKED_VERSION === 'true') {
              summary += '- No Tags will be created on main after merge.\n';
            } else {
              summary += 'The following tags will be created on main after merge:\n';
              const components = process.env.VALID_COMPONENTS.split(',');
              for (const component_version of components) {
                summary += `üè∑Ô∏è  \`${component_version.trim()}\`\n`;
              }
            }

            const body = `<!-- version-summary -->
            ## Version Tags
            ${summary}

            [View run](${runUrl})
            `;

            // Upsert by hidden marker to avoid duplicate comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find(c => c.body && c.body.includes("<!-- version-summary -->"));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }
