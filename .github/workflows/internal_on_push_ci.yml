name: Internal CI

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write # needed if reporter is github-pr-check or github-check

jobs:
  internal-ci2:
    name: Internal CI
    uses: ./.github/workflows/run_npm_ci_scripts.yml
    secrets: inherit
    with:
      working-directory: '.'
      commit-identifier: ${{ github.sha }}

  internal-ci:
    name: Internal CI (old)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install dependencies
        run: npm ci

      - name: Dependency Audit
        run: npm audit

      - name: Test
        run: npm test

      - name: Lint Check
        run: npm run lint:check

      - name: Format Check
        run: npm run format:check

  semgrep:
    uses: ./.github/workflows/run_semgrep_scan.yml
    secrets: inherit
    with:
      commit_identifier: ${{ github.sha }}
      cancel_in_progress: true
      semgrep_config: 'p/ci p/security-audit p/javascript'
      semgrep_targets: './*.js ./*.mjs ./*.json scripts/ .github/actions/' ## only scanning recently changed files, eventually should cover whole .github/actions/ folder
      fail_severity: 'error'
      semgrep_scan_mode: 'diff'
      reviewdog_filter_mode: 'added'
      reviewdog_reporter: 'github-pr-review'
