name: Internal CI

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write # needed if reporter is github-pr-check or github-check

jobs:
  internal-ci:
    name: Internal CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Install dependencies
        run: npm ci

      - name: Dependency Audit
        run: npm audit

      - name: Test
        run: npm test

      - name: Lint Check
        run: npm run lint:check

      - name: Format Check
        run: npm run format:check

  semgrep:
    uses: ./.github/workflows/run_semgrep_scan.yml
    secrets: inherit
    with:
      commit_identifier: ${{ github.sha }}
      cancel_in_progress: true
      semgrep_config: 'p/default'
      fail_severity: 'error'
      scan_mode: 'diff'
      pr_filter_mode: 'added'
      pr_reporter: 'github-pr-review'
